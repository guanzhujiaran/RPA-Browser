<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè§ˆå™¨æ§åˆ¶æµ‹è¯•ç•Œé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .result-box {
            background: #1e293b;
            color: #e2e8f0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        
        /* æˆªå›¾å’Œç›´æ’­é¢„è§ˆæ ·å¼ */
        .media-container {
            position: relative;
            background: #f8fafc;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .media-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
        }
        .media-container:hover .media-overlay {
            opacity: 1;
        }
        .media-info {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 15;
        }
        .live-status {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 15;
        }
        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        .live-dot.active {
            background: #10b981;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .screenshot-toolbar {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 15;
        }
        .toolbar-btn {
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toolbar-btn:hover {
            background: rgba(0,0,0,0.9);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">æµè§ˆå™¨æ§åˆ¶æµ‹è¯•ç•Œé¢</h1>
            <p class="text-gray-600">æµ‹è¯•æµè§ˆå™¨è‡ªåŠ¨åŒ–APIçš„å„é¡¹åŠŸèƒ½</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="space-y-6">
                <!-- åŸºç¡€é…ç½® -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">åŸºç¡€é…ç½®</h2>
                        <button onclick="testConnection()" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
                            æµ‹è¯•è¿æ¥
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Server URL</label>
                            <input type="text" id="serverUrl" value="http://127.0.0.1:8000/rpa" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Browser Token</label>
                            <input type="text" id="browserToken" placeholder="æµè§ˆå™¨Token" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Browser ID</label>
                            <input type="text" id="browserId" placeholder="æµè§ˆå™¨ID (å¯é€‰)" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="headless" class="mr-2">
                            <label for="headless" class="text-sm text-gray-700">æ— å¤´æ¨¡å¼</label>
                        </div>
                    </div>
                </div>

                <!-- åŠŸèƒ½æ“ä½œ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">åŠŸèƒ½æ“ä½œ</h2>
                    <div class="space-y-3">
                        <!-- æ‰“å¼€URL -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium mb-2">æ‰“å¼€URL</h3>
                            <input type="text" id="openUrl" placeholder="https://example.com" 
                                   class="w-full px-3 py-2 mb-2 border border-gray-300 rounded-md">
                            <button onclick="openUrl()" 
                                    class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                                æ‰“å¼€é¡µé¢
                            </button>
                        </div>

                        <!-- æˆªå›¾ -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium mb-2">æˆªå›¾</h3>
                            <div class="space-y-2">
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="fullPage" class="mr-2">
                                    <label for="fullPage" class="text-sm">æ•´é¡µæˆªå›¾</label>
                                    <select id="screenshotType" class="ml-4 px-2 py-1 border rounded">
                                        <option value="png">PNG</option>
                                        <option value="jpeg">JPEG</option>
                                    </select>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="screenshot()" 
                                            class="flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                                        æˆªå›¾
                                    </button>
                                    <button onclick="autoScreenshot()" 
                                            class="flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                                        è‡ªåŠ¨æˆªå›¾
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ç›´æ’­åŠŸèƒ½ -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium mb-2">ç›´æ’­åŠŸèƒ½</h3>
                            <div class="space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="createLive()" 
                                            class="bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 transition text-sm">
                                        åˆ›å»ºç›´æ’­
                                    </button>
                                    <button onclick="viewLive()" 
                                            class="bg-indigo-500 text-white px-3 py-2 rounded hover:bg-indigo-600 transition text-sm">
                                        æŸ¥çœ‹çŠ¶æ€
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="refreshLiveStream()" 
                                            class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition text-sm">
                                        åˆ·æ–°ç›´æ’­æµ
                                    </button>
                                    <button onclick="stopLive()" 
                                            class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition text-sm">
                                        åœæ­¢ç›´æ’­
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- é‡Šæ”¾ä¼šè¯ -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium mb-2">ä¼šè¯ç®¡ç†</h3>
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="releaseAll" class="mr-2">
                                <label for="releaseAll" class="text-sm">é‡Šæ”¾æ‰€æœ‰ä¼šè¯</label>
                            </div>
                            <button onclick="releaseSession()" 
                                    class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition">
                                é‡Šæ”¾ä¼šè¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ç»“æœå±•ç¤º -->
            <div class="space-y-6">
                <!-- å“åº”ç»“æœ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">APIå“åº”ç»“æœ</h2>
                    <div id="apiResult" class="result-box min-h-[200px] p-4 rounded text-sm">
                        ç­‰å¾…APIè°ƒç”¨...
                    </div>
                </div>

                <!-- å›¾ç‰‡å±•ç¤º -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">æˆªå›¾é¢„è§ˆ</h2>
                        <div id="screenshotStats" class="text-sm text-gray-600"></div>
                    </div>
                    <div id="screenshotPreview" class="media-container border-2 border-dashed border-gray-300 rounded-lg min-h-[200px] flex items-center justify-center">
                        <span class="text-gray-400">æˆªå›¾å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
                    </div>
                </div>

                <!-- ç›´æ’­é¢„è§ˆ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ç›´æ’­é¢„è§ˆ</h2>
                        <div id="liveStats" class="text-sm text-gray-600"></div>
                    </div>
                    <div id="livePreview" class="media-container border-2 border-dashed border-gray-300 rounded-lg min-h-[200px] flex items-center justify-center relative">
                        <span class="text-gray-400">ç›´æ’­æµå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
                        <div id="liveStatus" class="live-status hidden">
                            <div id="liveDot" class="live-dot"></div>
                            <span id="liveStatusText" class="text-xs text-gray-600">ç¦»çº¿</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- å¿«é€Ÿæµ‹è¯• -->
            <div class="mt-8 bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">å¿«é€Ÿæµ‹è¯•åœºæ™¯</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <button onclick="createTestBrowser()" 
                            class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition">
                        åˆ›å»ºæµ‹è¯•æµè§ˆå™¨
                    </button>
                    <button onclick="quickTest('bilibili')" 
                            class="bg-pink-500 text-white px-4 py-3 rounded-lg hover:bg-pink-600 transition">
                        æµ‹è¯•Bç«™é¡µé¢
                    </button>
                    <button onclick="quickTest('google')" 
                            class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition">
                        æµ‹è¯•Googleæœç´¢
                    </button>
                    <button onclick="quickTest('demo')" 
                            class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600 transition">
                        æ¼”ç¤ºæµç¨‹
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <p>ğŸ’¡ æç¤ºï¼šå¦‚æœæˆªå›¾æˆ–ç›´æ’­åŠŸèƒ½ä¸å·¥ä½œï¼Œè¯·å…ˆåˆ›å»ºæµ‹è¯•æµè§ˆå™¨å®ä¾‹</p>
                </div>
            </div>
    </div>

    <script>
        let currentLiveId = null;
        let liveRetryInterval = null;
        let currentScreenshotData = null;
        let liveStreamActive = false;
        let autoScreenshotInterval = null;

        // è·å–åŸºç¡€URL
        function getBaseUrl() {
            return document.getElementById('serverUrl').value;
        }

        // è·å–åŸºç¡€å‚æ•°
        function getBaseParams() {
            saveSettings(); // è‡ªåŠ¨ä¿å­˜è®¾ç½®
            const browserId = document.getElementById('browserId').value;
            return {
                browser_token: document.getElementById('browserToken').value,
                browser_id: browserId || null,
                headless: document.getElementById('headless').checked
            };
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(data, type = 'info') {
            const resultBox = document.getElementById('apiResult');
            resultBox.className = `result-box min-h-[200px] p-4 rounded text-sm ${type}`;
            
            // å¦‚æœæ˜¯HTMLå†…å®¹ï¼Œæ¸²æŸ“HTML
            if (typeof data === 'string' && data.includes('<span')) {
                resultBox.innerHTML = data;
            } else {
                resultBox.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            }
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            showResult('å¤„ç†ä¸­<span class="loading"></span>', 'info');
        }

        // APIè°ƒç”¨
        async function callApi(endpoint, method = 'POST', data = {}) {
            const baseUrl = getBaseUrl();
            const url = `${baseUrl}${endpoint}`;
            
            console.log(`API Call: ${method} ${url}`, data); // è°ƒè¯•æ—¥å¿—
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: method === 'POST' ? JSON.stringify(data) : undefined
                });

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    const textResult = await response.text();
                    console.error('Response parse error:', textResult);
                    showResult(`å“åº”è§£æå¤±è´¥: ${textResult}`, 'error');
                    return null;
                }
                
                console.log('API Response:', result); // è°ƒè¯•æ—¥å¿—
                
                if (response.ok) {
                    showResult(result, result.success ? 'success' : 'error');
                    return result;
                } else {
                    showResult(`é”™è¯¯ (${response.status}): ${result.msg || result.detail || 'Unknown error'}`, 'error');
                    return null;
                }
            } catch (error) {
                console.error('API call error:', error);
                showResult(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        // æ‰“å¼€URL
        async function openUrl() {
            const url = document.getElementById('openUrl').value;
            if (!url) {
                showResult('è¯·è¾“å…¥URL', 'error');
                return;
            }

            showLoading();
            const params = {
                ...getBaseParams(),
                url: url
            };

            await callApi('/browser_control/open_url', 'POST', params);
        }

        // æˆªå›¾
        async function screenshot() {
            showLoading();
            const params = {
                ...getBaseParams(),
                full_page: document.getElementById('fullPage').checked,
                type: document.getElementById('screenshotType').value
            };

            // éªŒè¯å¿…è¦å‚æ•°
            if (!params.browser_token) {
                showResult('è¯·è®¾ç½® Browser Token', 'error');
                return;
            }
            if (!params.browser_id) {
                showResult('è¯·è®¾ç½® Browser ID', 'error');
                return;
            }

            const preview = document.getElementById('screenshotPreview');
            const statsDiv = document.getElementById('screenshotStats');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            preview.innerHTML = '<div class="media-loading"><div class="loading"></div></div>';
            statsDiv.textContent = 'æ­£åœ¨ç”Ÿæˆæˆªå›¾...';

            const result = await callApi('/browser_control/screenshot', 'POST', params);
            console.log('Screenshot result:', result); // è°ƒè¯•ä¿¡æ¯
            
            if (result && result.success && result.data) {
                currentScreenshotData = result.data;
                
                // éªŒè¯æ•°æ®
                if (!result.data.image_base64) {
                    preview.innerHTML = '<div class="text-red-500 p-4">æˆªå›¾æ•°æ®ä¸ºç©º</div>';
                    statsDiv.textContent = 'æˆªå›¾æ•°æ®é”™è¯¯';
                    return;
                }
                
                // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                const imgElement = document.createElement('img');
                const imageType = params.type || 'png';
                imgElement.src = `data:image/${imageType};base64,${result.data.image_base64}`;
                imgElement.className = 'w-full rounded';
                imgElement.alt = 'æµè§ˆå™¨æˆªå›¾';
                
                // å›¾ç‰‡åŠ è½½å®Œæˆäº‹ä»¶
                imgElement.onload = function() {
                    // åˆ›å»ºä¿¡æ¯æ˜¾ç¤º
                    const info = document.createElement('div');
                    info.className = 'media-info';
                    info.textContent = `${this.naturalWidth} Ã— ${this.naturalHeight} | ${imageType.toUpperCase()}`;
                    
                    // åˆ›å»ºå·¥å…·æ 
                    const toolbar = document.createElement('div');
                    toolbar.className = 'screenshot-toolbar';
                    toolbar.innerHTML = `
                        <button class="toolbar-btn" onclick="downloadScreenshot()">ä¸‹è½½</button>
                        <button class="toolbar-btn" onclick="viewFullscreen()">å…¨å±</button>
                        <button class="toolbar-btn" onclick="copyScreenshot()">å¤åˆ¶</button>
                    `;
                    
                    // åˆ›å»ºæ‚¬åœå±‚
                    const overlay = document.createElement('div');
                    overlay.className = 'media-overlay';
                    overlay.innerHTML = '<span class="text-white text-sm">ç‚¹å‡»å›¾ç‰‡å…¨å±æŸ¥çœ‹</span>';
                    overlay.onclick = () => viewFullscreen();
                    
                    // ç»„è£…é¢„è§ˆåŒºåŸŸ
                    preview.innerHTML = '';
                    preview.appendChild(imgElement);
                    preview.appendChild(info);
                    preview.appendChild(toolbar);
                    preview.appendChild(overlay);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const timestamp = new Date().toLocaleString();
                    const fileSize = Math.round(result.data.image_base64.length * 0.75 / 1024);
                    statsDiv.textContent = `${timestamp} | ${fileSize}KB | ${imageType.toUpperCase()}`;
                };
                
                // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                imgElement.onerror = function() {
                    console.error('Image load error:', this.src.substring(0, 100));
                    preview.innerHTML = '<div class="text-red-500 p-4">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥Base64æ•°æ®</div>';
                    statsDiv.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
                
            } else {
                console.error('Screenshot API error:', result);
                preview.innerHTML = '<div class="text-red-500 p-4">æˆªå›¾APIè°ƒç”¨å¤±è´¥</div>';
                statsDiv.textContent = 'æˆªå›¾å¤±è´¥';
            }
        }

        // åˆ›å»ºç›´æ’­
        async function createLive() {
            showLoading();
            const params = getBaseParams();
            
            const result = await callApi('/browser_control/live/create', 'POST', params);
            if (result && result.success && result.data) {
                currentLiveId = result.data.live_id;
                showLiveStream(result.data.live_id);
                startLiveStatusCheck();
            }
        }

        // æŸ¥çœ‹ç›´æ’­çŠ¶æ€
        async function viewLive() {
            if (!currentLiveId) {
                showResult('è¯·å…ˆåˆ›å»ºç›´æ’­', 'error');
                return;
            }

            showLoading();
            const result = await callApi(`/browser_control/live/view?live_id=${currentLiveId}`, 'GET');
            if (result && result.success) {
                updateLiveStatus(true);
            }
        }

        // åœæ­¢ç›´æ’­
        async function stopLive() {
            if (!currentLiveId) {
                showResult('è¯·å…ˆåˆ›å»ºç›´æ’­', 'error');
                return;
            }

            showLoading();
            const result = await callApi(`/browser_control/live/stop?live_id=${currentLiveId}`, 'POST');
            if (result && result.success) {
                currentLiveId = null;
                liveStreamActive = false;
                stopLiveStatusCheck();
                resetLivePreview();
                showResult('ç›´æ’­å·²åœæ­¢', 'success');
            }
        }

        // æ˜¾ç¤ºç›´æ’­æµ
        function showLiveStream(liveId) {
            const baseUrl = getBaseUrl();
            const preview = document.getElementById('livePreview');
            
            // ç›´æ’­æµä½¿ç”¨MJPEGæµï¼Œä¸æ˜¯æ™®é€šå›¾ç‰‡
            const streamUrl = `${baseUrl}/browser_control/live/stream?live_id=${liveId}&t=${Date.now()}`;
            console.log('Live stream URL:', streamUrl);
            
            preview.innerHTML = `
                <img id="liveStreamImg" src="${streamUrl}" class="w-full rounded" alt="ç›´æ’­æµ" style="background: #000;">
                <div class="media-overlay">
                    <div class="text-white text-center">
                        <p class="mb-2">ç›´æ’­æµåŠ è½½ä¸­...</p>
                        <button class="toolbar-btn" onclick="refreshLiveStream()">åˆ·æ–°</button>
                        <button class="toolbar-btn" onclick="testLiveUrl()">æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>
            `;
            
            // å›¾ç‰‡åŠ è½½äº‹ä»¶å¤„ç†
            const liveImg = document.getElementById('liveStreamImg');
            
            // MJPEGæµä¼šæŒç»­åŠ è½½ï¼Œæˆ‘ä»¬ç”¨è¶…æ—¶æ¥åˆ¤æ–­
            const loadingTimeout = setTimeout(() => {
                if (!liveStreamActive) {
                    liveStreamActive = false;
                    updateLiveStatus(false);
                    const overlay = preview.querySelector('.media-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        overlay.querySelector('p').textContent = 'ç›´æ’­æµè¿æ¥è¶…æ—¶ï¼Œå¯èƒ½éœ€è¦é‡æ–°åˆ›å»º';
                    }
                }
            }, 10000); // 10ç§’è¶…æ—¶
            
            liveImg.onload = function() {
                clearTimeout(loadingTimeout);
                liveStreamActive = true;
                updateLiveStatus(true);
                const overlay = preview.querySelector('.media-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            };
            
            liveImg.onerror = function() {
                clearTimeout(loadingTimeout);
                console.error('Live stream error:', streamUrl);
                liveStreamActive = false;
                updateLiveStatus(false);
                const overlay = preview.querySelector('.media-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                    overlay.querySelector('p').textContent = 'ç›´æ’­æµåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨';
                }
            };
            
            // æ˜¾ç¤ºç›´æ’­çŠ¶æ€æŒ‡ç¤ºå™¨
            document.getElementById('liveStatus').classList.remove('hidden');
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateLiveStats('ç›´æ’­æµå·²åˆ›å»º');
        }
        
        // åˆ·æ–°ç›´æ’­æµ
        function refreshLiveStream() {
            if (currentLiveId) {
                showLiveStream(currentLiveId);
            }
        }
        
        // æµ‹è¯•ç›´æ’­URLè¿æ¥
        async function testLiveUrl() {
            if (!currentLiveId) {
                showResult('æ²¡æœ‰æ´»è·ƒçš„ç›´æ’­ä¼šè¯', 'error');
                return;
            }
            
            const baseUrl = getBaseUrl();
            const testUrl = `${baseUrl}/browser_control/live/view?live_id=${currentLiveId}`;
            
            try {
                const response = await fetch(testUrl);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Live session info:', data);
                    showResult('ç›´æ’­ä¼šè¯æ­£å¸¸ï¼š' + JSON.stringify(data.data, null, 2), 'success');
                } else {
                    showResult('ç›´æ’­ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ', 'error');
                }
            } catch (error) {
                showResult('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testConnection() {
            const baseUrl = getBaseUrl();
            const browserToken = document.getElementById('browserToken').value;
            const browserId = document.getElementById('browserId').value;
            
            showLoading();
            
            try {
                // æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
                const response = await fetch(baseUrl + '/browser/list_fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        browser_token: browserToken || '550e8400-e29b-41d4-a716-446655440000',
                        page: 1,
                        per_page: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼\n\n' + JSON.stringify(data, null, 2), 'success');
                } else {
                    const errorData = await response.text();
                    showResult(`æœåŠ¡å™¨è¿æ¥å¤±è´¥ (${response.status}): ${errorData}`, 'error');
                }
            } catch (error) {
                showResult('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ›å»ºæµ‹è¯•æµè§ˆå™¨å®ä¾‹
        async function createTestBrowser() {
            showLoading();
            const baseUrl = getBaseUrl();
            
            try {
                // 1. ç”Ÿæˆæµè§ˆå™¨æŒ‡çº¹
                const browserToken = generateUUID();
                console.log('Creating browser with token:', browserToken);
                
                const genResponse = await fetch(baseUrl + '/browser/gen_rand_fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        browser_token: browserToken,
                        name: 'æµ‹è¯•æµè§ˆå™¨_' + Date.now()
                    })
                });
                
                if (!genResponse.ok) {
                    const errorText = await genResponse.text();
                    showResult(`ç”ŸæˆæŒ‡çº¹å¤±è´¥: ${errorText}`, 'error');
                    return;
                }
                
                const genResult = await genResponse.json();
                console.log('Fingerprint generated:', genResult);
                
                // 2. åˆ›å»ºæµè§ˆå™¨å®ä¾‹
                const createResponse = await fetch(baseUrl + '/browser/create_fingerprint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        browser_token: browserToken,
                        name: 'æµ‹è¯•æµè§ˆå™¨_' + Date.now(),
                        platform: 'win32',
                        user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    })
                });
                
                if (!createResponse.ok) {
                    const errorText = await createResponse.text();
                    showResult(`åˆ›å»ºæµè§ˆå™¨å¤±è´¥: ${errorText}`, 'error');
                    return;
                }
                
                const createResult = await createResponse.json();
                console.log('Browser created:', createResult);
                
                // 3. è·å–æµè§ˆå™¨ID
                if (createResult.success && createResult.data) {
                    const browserId = createResult.data.id || '1';
                    
                    // æ›´æ–°è¡¨å•
                    document.getElementById('browserToken').value = browserToken;
                    document.getElementById('browserId').value = browserId;
                    
                    showResult(`âœ… æµ‹è¯•æµè§ˆå™¨åˆ›å»ºæˆåŠŸï¼\n\nBrowser Token: ${browserToken}\nBrowser ID: ${browserId}\n\nå·²è‡ªåŠ¨å¡«å…¥è¡¨å•ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼`, 'success');
                    
                    // ä¿å­˜è®¾ç½®
                    saveSettings();
                } else {
                    showResult('åˆ›å»ºæµè§ˆå™¨æˆåŠŸä½†æœªè·å–åˆ°ID', 'error');
                }
                
            } catch (error) {
                console.error('Create browser error:', error);
                showResult('åˆ›å»ºæµ‹è¯•æµè§ˆå™¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å¼€å§‹ç›´æ’­çŠ¶æ€æ£€æŸ¥
        function startLiveStatusCheck() {
            if (liveRetryInterval) {
                clearInterval(liveRetryInterval);
            }
            
            liveRetryInterval = setInterval(async () => {
                if (currentLiveId && liveStreamActive) {
                    try {
                        const response = await fetch(`${getBaseUrl()}/browser_control/live/view?live_id=${currentLiveId}`);
                        const result = await response.json();
                        updateLiveStatus(result.success);
                    } catch (error) {
                        updateLiveStatus(false);
                    }
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // åœæ­¢ç›´æ’­çŠ¶æ€æ£€æŸ¥
        function stopLiveStatusCheck() {
            if (liveRetryInterval) {
                clearInterval(liveRetryInterval);
                liveRetryInterval = null;
            }
        }
        
        // æ›´æ–°ç›´æ’­çŠ¶æ€
        function updateLiveStatus(isActive) {
            const dot = document.getElementById('liveDot');
            const text = document.getElementById('liveStatusText');
            
            if (isActive) {
                dot.classList.add('active');
                text.textContent = 'åœ¨çº¿';
                text.className = 'text-xs text-green-600';
            } else {
                dot.classList.remove('active');
                text.textContent = 'ç¦»çº¿';
                text.className = 'text-xs text-red-600';
            }
        }
        
        // é‡ç½®ç›´æ’­é¢„è§ˆ
        function resetLivePreview() {
            const preview = document.getElementById('livePreview');
            preview.innerHTML = '<span class="text-gray-400">ç›´æ’­æµå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>';
            document.getElementById('liveStatus').classList.add('hidden');
            document.getElementById('liveStats').textContent = '';
        }
        
        // æ›´æ–°ç›´æ’­ç»Ÿè®¡ä¿¡æ¯
        function updateLiveStats(message) {
            const statsDiv = document.getElementById('liveStats');
            const timestamp = new Date().toLocaleTimeString();
            statsDiv.textContent = `${timestamp} | ${message}`;
        }

        // é‡Šæ”¾ä¼šè¯
        async function releaseSession() {
            showLoading();
            const params = {
                browser_token: getBaseParams().browser_token,
                browser_id: document.getElementById('releaseAll').checked ? null : getBaseParams().browser_id
            };

            await callApi('/browser_control/release_session', 'POST', params);
        }

        // å¿«é€Ÿæµ‹è¯•
        async function quickTest(type) {
            const browserToken = document.getElementById('browserToken').value;
            const browserId = document.getElementById('browserId').value;
            
            if (!browserToken || !browserId) {
                showResult('è¯·å…ˆè®¾ç½®Browser Tokenå’ŒBrowser IDï¼Œæˆ–ç‚¹å‡»"åˆ›å»ºæµ‹è¯•æµè§ˆå™¨"', 'error');
                return;
            }

            showResult('å¼€å§‹å¿«é€Ÿæµ‹è¯•...', 'info');
            
            try {
                switch(type) {
                    case 'bilibili':
                        document.getElementById('openUrl').value = 'https://www.bilibili.com';
                        await openUrl();
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        await screenshot();
                        break;
                        
                    case 'google':
                        document.getElementById('openUrl').value = 'https://www.google.com';
                        await openUrl();
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        await screenshot();
                        break;
                        
                    case 'demo':
                        // æ¼”ç¤ºå®Œæ•´æµç¨‹
                        showResult('å¼€å§‹æ¼”ç¤ºå®Œæ•´æµç¨‹...', 'info');
                        document.getElementById('openUrl').value = 'https://www.example.com';
                        await openUrl();
                        showResult('é¡µé¢å·²æ‰“å¼€ï¼Œç­‰å¾…åŠ è½½...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        await screenshot();
                        showResult('æˆªå›¾å®Œæˆï¼Œåˆ›å»ºç›´æ’­...', 'info');
                        await createLive();
                        showResult('æ¼”ç¤ºå®Œæˆï¼', 'success');
                        break;
                }
            } catch (error) {
                showResult('å¿«é€Ÿæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é¢„å¡«ä¸€äº›æµ‹è¯•æ•°æ®
            showResult('ğŸ‰ æµè§ˆå™¨æ§åˆ¶æµ‹è¯•ç•Œé¢å·²åŠ è½½ï¼\n\nğŸš€ å¿«é€Ÿå¼€å§‹ï¼š\n1. ç‚¹å‡»"åˆ›å»ºæµ‹è¯•æµè§ˆå™¨"æŒ‰é’®è‡ªåŠ¨åˆ›å»ºæµè§ˆå™¨å®ä¾‹\n2. æˆ–è€…æ‰‹åŠ¨è®¾ç½®Browser Tokenå’ŒBrowser ID\n3. ä½¿ç”¨"å¿«é€Ÿæµ‹è¯•åœºæ™¯"éªŒè¯åŠŸèƒ½\n\nğŸ“ åŠŸèƒ½è¯´æ˜ï¼š\n- æˆªå›¾ï¼šæ”¯æŒPNG/JPEGï¼Œå¯æ•´é¡µæˆªå›¾\n- ç›´æ’­ï¼šå®æ—¶æµè§ˆå™¨ç”»é¢ç›´æ’­\n- è‡ªåŠ¨æˆªå›¾ï¼šå®šæ—¶è¿ç»­æˆªå›¾åŠŸèƒ½\n\nğŸ® å¿«æ·é”®ï¼š\n- Ctrl+S: æˆªå›¾\n- Ctrl+L: åˆ›å»º/åœæ­¢ç›´æ’­\n- Ctrl+R: åˆ·æ–°ç›´æ’­æµ\n- Ctrl+D: ä¸‹è½½æˆªå›¾\n- Ctrl+F: å…¨å±æŸ¥çœ‹æˆªå›¾\n- ESC: åœæ­¢æ‰€æœ‰è‡ªåŠ¨æ“ä½œ\n\nğŸ”§ è°ƒè¯•åŠŸèƒ½ï¼š\n- æµ‹è¯•è¿æ¥ï¼šæ£€æŸ¥æœåŠ¡å™¨è¿é€šæ€§\n- æ§åˆ¶å°æ—¥å¿—ï¼šæŸ¥çœ‹è¯¦ç»†çš„APIè°ƒç”¨ä¿¡æ¯\n\nâš ï¸ æ³¨æ„äº‹é¡¹ï¼š\n- ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ\n- é¦–æ¬¡ä½¿ç”¨å»ºè®®å…ˆåˆ›å»ºæµ‹è¯•æµè§ˆå™¨\n- é‡åˆ°é”™è¯¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°\n\nğŸš€ å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹æµ‹è¯•å§ï¼', 'info');
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', function(event) {
                // Ctrl/Cmd ç»„åˆé”®
                if (event.ctrlKey || event.metaKey) {
                    switch(event.key.toLowerCase()) {
                        case 's':
                            event.preventDefault();
                            screenshot();
                            break;
                        case 'l':
                            event.preventDefault();
                            if (currentLiveId) {
                                stopLive();
                            } else {
                                createLive();
                            }
                            break;
                        case 'r':
                            event.preventDefault();
                            refreshLiveStream();
                            break;
                        case 'd':
                            event.preventDefault();
                            downloadScreenshot();
                            break;
                        case 'f':
                            event.preventDefault();
                            viewFullscreen();
                            break;
                    }
                }
                
                // ESC é”®
                if (event.key === 'Escape') {
                    // åœæ­¢æ‰€æœ‰è‡ªåŠ¨æ“ä½œ
                    if (autoScreenshotInterval) {
                        autoScreenshot();
                    }
                    if (currentLiveId) {
                        stopLive();
                    }
                }
            });
            
            // æ·»åŠ URLè¾“å…¥æ¡†çš„å›è½¦æ”¯æŒ
            document.getElementById('openUrl').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    openUrl();
                }
            });
            
            // æ·»åŠ è‡ªåŠ¨ä¿å­˜è®¾ç½®åˆ°localStorage
            loadSettings();
        });
        
        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const savedToken = localStorage.getItem('browserToken');
            const savedBrowserId = localStorage.getItem('browserId');
            const savedServerUrl = localStorage.getItem('serverUrl');
            
            if (savedToken) document.getElementById('browserToken').value = savedToken;
            if (savedBrowserId) document.getElementById('browserId').value = savedBrowserId;
            if (savedServerUrl) document.getElementById('serverUrl').value = savedServerUrl;
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            localStorage.setItem('browserToken', document.getElementById('browserToken').value);
            localStorage.setItem('browserId', document.getElementById('browserId').value);
            localStorage.setItem('serverUrl', document.getElementById('serverUrl').value);
        }

        // ç”ŸæˆUUIDçš„è¾…åŠ©å‡½æ•°
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // ä¸‹è½½æˆªå›¾
        function downloadScreenshot() {
            if (!currentScreenshotData || !currentScreenshotData.image_base64) {
                showResult('æ²¡æœ‰å¯ä¸‹è½½çš„æˆªå›¾', 'error');
                return;
            }
            
            try {
                const link = document.createElement('a');
                const type = document.getElementById('screenshotType').value;
                link.download = `screenshot_${Date.now()}.${type}`;
                link.href = `data:image/${type};base64,${currentScreenshotData.image_base64}`;
                link.click();
                showResult('æˆªå›¾å·²ä¸‹è½½', 'success');
            } catch (error) {
                showResult(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å…¨å±æŸ¥çœ‹æˆªå›¾
        function viewFullscreen() {
            if (!currentScreenshotData || !currentScreenshotData.image_base64) {
                showResult('æ²¡æœ‰å¯æŸ¥çœ‹çš„æˆªå›¾', 'error');
                return;
            }
            
            try {
                const type = document.getElementById('screenshotType').value;
                const imageWindow = window.open();
                imageWindow.document.write(`
                    <html>
                        <head><title>æˆªå›¾é¢„è§ˆ</title></head>
                        <body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;height:100vh;">
                            <img src="data:image/${type};base64,${currentScreenshotData.image_base64}" 
                                 style="max-width:100%;max-height:100%;object-fit:contain;">
                        </body>
                    </html>
                `);
            } catch (error) {
                showResult(`æ— æ³•æ‰“å¼€å…¨å±æŸ¥çœ‹: ${error.message}`, 'error');
            }
        }
        
        // å¤åˆ¶æˆªå›¾åˆ°å‰ªè´´æ¿
        async function copyScreenshot() {
            if (!currentScreenshotData || !currentScreenshotData.image_base64) {
                showResult('æ²¡æœ‰å¯å¤åˆ¶çš„æˆªå›¾', 'error');
                return;
            }
            
            try {
                const type = document.getElementById('screenshotType').value;
                const response = await fetch(`data:image/${type};base64,${currentScreenshotData.image_base64}`);
                const blob = await response.blob();
                
                await navigator.clipboard.write([
                    new ClipboardItem({ [`image/${type}`]: blob })
                ]);
                
                showResult('æˆªå›¾å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (error) {
                // å¦‚æœç°ä»£APIä¸æ”¯æŒï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = currentScreenshotData.image_base64;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showResult('æˆªå›¾Base64å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'info');
                } catch (fallbackError) {
                    showResult(`å¤åˆ¶å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
        
        // è‡ªåŠ¨æˆªå›¾åŠŸèƒ½
        function autoScreenshot() {
            const browserToken = document.getElementById('browserToken').value;
            if (!browserToken) {
                showResult('è¯·å…ˆè®¾ç½®Browser Token', 'error');
                return;
            }
            
            if (autoScreenshotInterval) {
                // åœæ­¢è‡ªåŠ¨æˆªå›¾
                clearInterval(autoScreenshotInterval);
                autoScreenshotInterval = null;
                showResult('è‡ªåŠ¨æˆªå›¾å·²åœæ­¢', 'info');
                document.querySelector('button[onclick="autoScreenshot()"]').textContent = 'è‡ªåŠ¨æˆªå›¾';
                document.querySelector('button[onclick="autoScreenshot()"]').classList.remove('bg-red-500');
                document.querySelector('button[onclick="autoScreenshot()"]').classList.add('bg-blue-500');
            } else {
                // å¼€å§‹è‡ªåŠ¨æˆªå›¾
                autoScreenshotInterval = setInterval(async () => {
                    await screenshot();
                }, 5000); // æ¯5ç§’æˆªå›¾ä¸€æ¬¡
                
                showResult('è‡ªåŠ¨æˆªå›¾å·²å¯åŠ¨ï¼ˆæ¯5ç§’ï¼‰', 'success');
                document.querySelector('button[onclick="autoScreenshot()"]').textContent = 'åœæ­¢è‡ªåŠ¨æˆªå›¾';
                document.querySelector('button[onclick="autoScreenshot()"]').classList.remove('bg-blue-500');
                document.querySelector('button[onclick="autoScreenshot()"]').classList.add('bg-red-500');
                
                // ç«‹å³æˆªå›¾ä¸€æ¬¡
                screenshot();
            }
        }
        
        // æ¸…ç†å‡½æ•° - é¡µé¢å¸è½½æ—¶è°ƒç”¨
        window.addEventListener('beforeunload', function() {
            stopLiveStatusCheck();
            if (autoScreenshotInterval) {
                clearInterval(autoScreenshotInterval);
            }
        });
    </script>
</body>
</html>